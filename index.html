<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Pronunciation Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .word-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .word-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .game-card {
            transition: transform 0.2s, background-color 0.2s;
        }
        .game-card:active {
            transform: scale(0.95);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.2s ease-in-out 0s 2; }
        
        .speed-slider::-webkit-slider-runnable-track {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            background: #3b82f6;
            margin-top: -6px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Mic pulse animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444 !important;
        }

        .cat-pill {
            padding: 0.375rem 1rem;
            border-radius: 9999px;
            border: 1px solid #e2e8f0;
            font-size: 0.75rem;
            font-weight: 700;
            transition: all 0.2s;
            color: #64748b;
        }
        .active-pill {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i class="fas fa-microphone-alt text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Pronounce<span class="text-blue-600">Pro</span></h1>
            </div>
            
            <div class="flex flex-wrap justify-center gap-1 items-center bg-slate-100 p-1 rounded-full">
                <button onclick="setTab('cvc')" id="tab-cvc" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm">CVC</button>
                <button onclick="setTab('cvcc')" id="tab-cvcc" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm">CVCC</button>
                <button onclick="setTab('other')" id="tab-other" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm">Advanced</button>
                <button onclick="setTab('custom')" id="tab-custom" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm flex items-center gap-1">
                    <i class="fas fa-plus-circle text-blue-500"></i> My Words
                </button>
                <div class="w-px h-6 bg-slate-300 mx-1"></div>
                <button onclick="setTab('game')" id="tab-game" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm flex items-center gap-1">
                    <i class="fas fa-ear-listen"></i> Listen
                </button>
                <button onclick="setTab('spelling')" id="tab-spelling" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm flex items-center gap-1">
                    <i class="fas fa-keyboard"></i> Spell
                </button>
                <button onclick="setTab('speaking')" id="tab-speaking" class="px-3 md:px-4 py-2 rounded-full font-semibold transition-all duration-200 text-sm flex items-center gap-1">
                    <i class="fas fa-headset"></i> Speak
                </button>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow max-w-6xl mx-auto w-full p-4 md:p-6">
        
        <!-- Controls & Stats Bar -->
        <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 font-medium" id="stat-label-1">Progress</p>
                    <p class="text-xl font-bold text-slate-800" id="progress-text">0/100</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                    <i class="fas fa-chart-line" id="stat-icon-1"></i>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Voice Speed</p>
                    <span id="speed-val" class="text-xs font-bold text-blue-600">1.0x</span>
                </div>
                <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" class="speed-slider w-full h-1.5 appearance-none cursor-pointer" id="speed-control" oninput="updateSpeedUI()">
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 font-medium">Mode</p>
                    <p class="text-xl font-bold text-slate-800 capitalize" id="current-category-label">CVC Words</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
                    <i class="fas fa-layer-group" id="mode-icon"></i>
                </div>
            </div>

            <div id="search-box" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <div class="relative">
                    <input type="text" id="search-input" oninput="handleSearch()" placeholder="Search dictionary..." class="w-full pl-8 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i class="fas fa-search absolute left-2.5 top-3 text-slate-400 text-xs"></i>
                </div>
            </div>

            <!-- Streak box (initially hidden) -->
            <div id="streak-box" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 font-medium">Streak</p>
                    <p class="text-xl font-bold text-orange-600" id="current-streak-val">0</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
                    <i class="fas fa-fire"></i>
                </div>
            </div>
        </div>

        <!-- Custom Words Management Interface -->
        <div id="custom-words-interface" class="hidden flex flex-col gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h2 class="text-xl font-bold text-slate-800 mb-2">My Vocabulary</h2>
                <p class="text-slate-500 text-sm mb-4">Add your own words manually or upload a text file.</p>
                <div class="flex flex-col gap-4">
                    <textarea id="custom-upload-input" rows="3" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm" placeholder="Type words here, one per line..."></textarea>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="addCustomWords()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i class="fas fa-plus"></i> Add Words
                        </button>
                        <label class="bg-indigo-50 text-indigo-700 px-6 py-2 rounded-lg font-bold hover:bg-indigo-100 transition-colors cursor-pointer flex items-center gap-2 border border-indigo-200">
                            <i class="fas fa-file-import"></i> Import .txt File
                            <input type="file" id="file-import" accept=".txt" class="hidden" onchange="handleFileImport(event)">
                        </label>
                        <button onclick="clearCustomWords()" class="bg-slate-100 text-slate-600 px-6 py-2 rounded-lg font-bold hover:bg-slate-200 transition-colors flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Grid (Dictionary View) -->
        <div id="word-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Words injected here -->
        </div>

        <!-- Ear Trainer Interface -->
        <div id="game-interface" class="hidden max-w-2xl mx-auto py-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Ear Trainer</h2>
                <p class="text-slate-500 text-sm">Listen and pick the correct card.</p>
            </div>
            <div class="bg-white rounded-3xl shadow-xl border border-slate-200 p-8 flex flex-col items-center gap-6">
                <button onclick="playCurrentGameWord()" class="w-20 h-20 rounded-full bg-blue-600 text-white text-2xl hover:bg-blue-700 transition-colors shadow-lg flex items-center justify-center">
                    <i class="fas fa-volume-up"></i>
                </button>
                <div id="game-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full"></div>
            </div>
        </div>

        <!-- Spelling Bee Interface -->
        <div id="spelling-interface" class="hidden max-w-2xl mx-auto py-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Spelling Bee</h2>
                <p class="text-slate-500 text-sm">Listen carefully and type the word you hear.</p>
                <div class="flex flex-wrap justify-center gap-2 mt-4">
                    <button onclick="setGameCategory('cvc')" class="cat-pill active-pill" id="spell-cat-cvc">CVC</button>
                    <button onclick="setGameCategory('cvcc')" class="cat-pill" id="spell-cat-cvcc">CVCC</button>
                    <button onclick="setGameCategory('other')" class="cat-pill" id="spell-cat-other">Advanced</button>
                    <button onclick="setGameCategory('custom')" class="cat-pill" id="spell-cat-custom">My Words</button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl border border-slate-200 p-8 flex flex-col items-center gap-6">
                <button onclick="playCurrentGameWord()" class="w-20 h-20 rounded-full bg-purple-600 text-white text-2xl hover:bg-purple-700 transition-colors shadow-lg flex items-center justify-center">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="w-full">
                    <input type="text" id="spelling-input" autocomplete="off" autofocus class="w-full text-center text-3xl font-black tracking-widest uppercase py-4 border-b-4 border-slate-200 focus:outline-none focus:border-purple-500 text-slate-700" placeholder="Type here...">
                    <p id="spelling-hint" class="text-center mt-2 text-slate-400 text-sm italic font-medium">&nbsp;</p>
                </div>
                <button onclick="checkSpelling()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-black transition-colors">Submit Answer</button>
            </div>
        </div>

        <!-- Speaking Challenge Interface -->
        <div id="speaking-interface" class="hidden max-w-2xl mx-auto py-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Speaking Challenge</h2>
                <p class="text-slate-500 text-sm">Read the word aloud to win!</p>
                <div class="flex flex-wrap justify-center gap-2 mt-4">
                    <button onclick="setGameCategory('cvc')" class="cat-pill active-pill" id="speak-cat-cvc">CVC</button>
                    <button onclick="setGameCategory('cvcc')" class="cat-pill" id="speak-cat-cvcc">CVCC</button>
                    <button onclick="setGameCategory('other')" class="cat-pill" id="speak-cat-other">Advanced</button>
                    <button onclick="setGameCategory('custom')" class="cat-pill" id="speak-cat-custom">My Words</button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl border border-slate-200 p-8 flex flex-col items-center gap-6">
                <div class="text-center">
                    <h3 id="speaking-target-word" class="text-5xl font-black text-slate-800 tracking-tight uppercase">Ready?</h3>
                    <p id="speaking-target-fr" class="text-slate-400 italic mt-1 uppercase text-sm"></p>
                </div>

                <!-- Heard Text Display -->
                <div id="heard-display" class="hidden w-full text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs text-slate-400 uppercase font-bold tracking-widest mb-1">What we heard</p>
                    <p id="transcript-text" class="text-2xl font-bold text-blue-600 capitalize"></p>
                </div>
                
                <div class="flex flex-col items-center gap-6 w-full">
                    <div class="flex gap-4">
                        <button onclick="playCurrentGameWord()" class="w-16 h-16 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 transition-all flex items-center justify-center">
                            <i class="fas fa-volume-up text-xl"></i>
                        </button>
                        <button id="mic-button" onclick="startVoiceRecognition()" class="w-20 h-20 rounded-full bg-blue-600 text-white text-2xl hover:bg-blue-700 transition-all shadow-lg flex items-center justify-center">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>

                    <div id="speaking-result" class="text-center h-8 font-bold text-lg">
                        <!-- Success/Fail Message -->
                    </div>

                    <!-- Manual Proceed Button -->
                    <button id="check-next-btn" onclick="validateAndProceed()" class="hidden w-full py-4 bg-green-600 text-white rounded-2xl font-bold hover:bg-green-700 transition-all shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> Check & Next Word
                    </button>
                </div>
            </div>
        </div>

        <div id="no-results" class="hidden py-20 text-center">
            <i class="fas fa-search-minus text-4xl text-slate-300 mb-4"></i>
            <p class="text-slate-500">No matches found.</p>
        </div>
    </main>

    <!-- Audio Toast -->
    <div id="audio-toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-50">
        <i class="fas fa-volume-up text-blue-400"></i>
        <span id="toast-word" class="font-bold tracking-wider"></span>
    </div>

    <script>
        const wordData = {
            cvc: [
                {en: "bat", fr: "chauve-souris"}, {en: "cat", fr: "chat"}, {en: "hat", fr: "chapeau"}, {en: "mat", fr: "tapis"}, {en: "rat", fr: "rat"}, {en: "sat", fr: "assis"}, {en: "fat", fr: "gros"}, {en: "pat", fr: "tapoter"}, {en: "map", fr: "carte"}, {en: "tap", fr: "robinet"},
                {en: "cap", fr: "casquette"}, {en: "lap", fr: "tour"}, {en: "nap", fr: "sieste"}, {en: "sap", fr: "sève"}, {en: "gap", fr: "écart"}, {en: "bag", fr: "sac"}, {en: "tag", fr: "étiquette"}, {en: "rag", fr: "chiffon"}, {en: "wag", fr: "remuer"}, {en: "sag", fr: "s'affaisser"},
                {en: "pen", fr: "stylo"}, {en: "hen", fr: "poule"}, {en: "ten", fr: "dix"}, {en: "men", fr: "hommes"}, {en: "den", fr: "tanière"}, {en: "net", fr: "filet"}, {en: "pet", fr: "animal"}, {en: "set", fr: "ensemble"}, {en: "met", fr: "rencontré"}, {en: "wet", fr: "mouillé"},
                {en: "get", fr: "obtenir"}, {en: "bet", fr: "parier"}, {en: "jet", fr: "avion"}, {en: "let", fr: "laisser"}, {en: "red", fr: "rouge"}, {en: "bed", fr: "lit"}, {en: "fed", fr: "nourri"}, {en: "led", fr: "mené"}, {en: "wed", fr: "marié"}, {en: "bin", fr: "bac"},
                {en: "fin", fr: "nageoire"}, {en: "pin", fr: "épingle"}, {en: "tin", fr: "étain"}, {en: "win", fr: "gagner"}, {en: "sin", fr: "péché"}, {en: "kin", fr: "parenté"}, {en: "bit", fr: "morceau"}, {en: "fit", fr: "ajuster"}, {en: "hit", fr: "frapper"}, {en: "lit", fr: "éclairé"},
                {en: "pit", fr: "fosse"}, {en: "sit", fr: "s'asseoir"}, {en: "kit", fr: "trousse"}, {en: "big", fr: "grand"}, {en: "dig", fr: "creuser"}, {en: "fig", fr: "figue"}, {en: "pig", fr: "cochon"}, {en: "wig", fr: "perruque"}, {en: "rig", fr: "appareil"}, {en: "hop", fr: "sauter"},
                {en: "mop", fr: "serpillière"}, {en: "top", fr: "haut"}, {en: "pop", fr: "éclater"}, {en: "cop", fr: "flic"}, {en: "hot", fr: "chaud"}, {en: "not", fr: "ne pas"}, {en: "pot", fr: "casserole"}, {en: "dot", fr: "point"}, {en: "got", fr: "obtenu"}, {en: "lot", fr: "beaucoup"},
                {en: "rot", fr: "pourrir"}, {en: "fox", fr: "renard"}, {en: "box", fr: "boîte"}, {en: "log", fr: "bûche"}, {en: "dog", fr: "chien"}, {en: "fog", fr: "brouillard"}, {en: "jog", fr: "jogging"}, {en: "hog", fr: "porc"}, {en: "sun", fr: "soleil"}, {en: "run", fr: "courir"},
                {en: "fun", fr: "amusement"}, {en: "gun", fr: "pistolet"}, {en: "bun", fr: "petit pain"}, {en: "pun", fr: "calembour"}, {en: "nun", fr: "religieuse"}, {en: "cut", fr: "couper"}, {en: "but", fr: "mais"}, {en: "hut", fr: "cabane"}, {en: "nut", fr: "noisette"}, {en: "gut", fr: "intestin"},
                {en: "rug", fr: "tapis"}, {en: "bug", fr: "insecte"}, {en: "hug", fr: "câlin"}, {en: "jug", fr: "cruche"}, {en: "mug", fr: "tasse"}, {en: "tug", fr: "remorqueur"}, {en: "pug", fr: "carlin"}, {en: "sub", fr: "sous-marin"}, {en: "tub", fr: "baignoire"}, {en: "rub", fr: "frotter"}
            ],
            cvcc: [
                {en: "belt", fr: "ceinture"}, {en: "felt", fr: "feutre"}, {en: "melt", fr: "fondre"}, {en: "pelt", fr: "peau"}, {en: "wilt", fr: "flétrir"}, {en: "tilt", fr: "incliner"}, {en: "jilt", fr: "éconduire"}, {en: "silt", fr: "limon"}, {en: "hand", fr: "main"}, {en: "band", fr: "bande"},
                {en: "sand", fr: "sable"}, {en: "land", fr: "terre"}, {en: "fond", fr: "affectueux"}, {en: "pond", fr: "étang"}, {en: "bond", fr: "lien"}, {en: "bend", fr: "plier"}, {en: "mend", fr: "réparer"}, {en: "send", fr: "envoyer"}, {en: "tend", fr: "tendre"}, {en: "wind", fr: "vent"},
                {en: "back", fr: "dos"}, {en: "lack", fr: "manque"}, {en: "pack", fr: "paquet"}, {en: "sack", fr: "sac"}, {en: "tack", fr: "punaise"}, {en: "deck", fr: "pont"}, {en: "neck", fr: "cou"}, {en: "peck", fr: "bécoter"}, {en: "kick", fr: "coup de pied"}, {en: "lick", fr: "lécher"},
                {en: "nick", fr: "entaille"}, {en: "pick", fr: "choisir"}, {en: "sick", fr: "malade"}, {en: "tick", fr: "tique"}, {en: "wick", fr: "mèche"}, {en: "lock", fr: "serrure"}, {en: "rock", fr: "rocher"}, {en: "sock", fr: "chaussette"}, {en: "dock", fr: "quai"}, {en: "buck", fr: "mâle"},
                {en: "duck", fr: "canard"}, {en: "luck", fr: "chance"}, {en: "puck", fr: "palet"}, {en: "tuck", fr: "replier"}, {en: "lamp", fr: "lampe"}, {en: "camp", fr: "camp"}, {en: "ramp", fr: "rampe"}, {en: "damp", fr: "humide"}, {en: "bump", fr: "bosse"}, {en: "jump", fr: "sauter"},
                {en: "lump", fr: "bosse"}, {en: "pump", fr: "pompe"}, {en: "dump", fr: "décharge"}, {en: "hump", fr: "bosse"}, {en: "fast", fr: "rapide"}, {en: "last", fr: "dernier"}, {en: "past", fr: "passé"}, {en: "mast", fr: "mât"}, {en: "best", fr: "meilleur"}, {en: "vest", fr: "gilet"},
                {en: "test", fr: "test"}, {en: "rest", fr: "repos"}, {en: "west", fr: "ouest"}, {en: "jest", fr: "plaisanterie"}, {en: "mist", fr: "brume"}, {en: "list", fr: "liste"}, {en: "fist", fr: "poing"}, {en: "gift", fr: "cadeau"}, {en: "lift", fr: "ascenseur"}, {en: "sift", fr: "tamiser"}
            ],
            other: [
                {en: "adventure", fr: "aventure"}, {en: "beautiful", fr: "beau"}, {en: "challenge", fr: "défi"}, {en: "different", fr: "différent"}, {en: "education", fr: "éducation"}, {en: "frequency", fr: "fréquence"}, {en: "generate", fr: "générer"}, {en: "hospital", fr: "hôpital"}, {en: "imagine", fr: "imaginer"}, {en: "journey", fr: "voyage"},
                {en: "knowledge", fr: "connaissance"}, {en: "language", fr: "langue"}, {en: "mountain", fr: "montagne"}, {en: "neighbor", fr: "voisin"}, {en: "opposite", fr: "opposé"}, {en: "practice", fr: "pratique"}, {en: "question", fr: "question"}, {en: "remember", fr: "se souvenir"}, {en: "sentence", fr: "phrase"}, {en: "together", fr: "ensemble"}
            ],
            custom: []
        };

        // State
        let currentTab = 'cvc';
        let progress = { cvc: new Set(), cvcc: new Set(), other: new Set(), custom: new Set() };
        let currentVoice = null;
        let voiceSpeed = 1.0;
        let streak = 0;
        let currentGameWord = null;
        let gameCategory = 'cvc';
        let isRecognitionActive = false;

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // Sound Synthesis (Beeper)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            win: () => { playTone(523.25, 'sine', 0.15); setTimeout(() => playTone(659.25, 'sine', 0.2), 100); },
            fail: () => { playTone(150, 'square', 0.3); }
        };

        window.onload = () => {
            initVoices();
            loadProgress();
            setTab('cvc');
            
            document.getElementById('spelling-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkSpelling();
            });

            if (recognition) {
                recognition.onstart = () => { isRecognitionActive = true; };
                recognition.onresult = (event) => {
                    isRecognitionActive = false;
                    const speechResult = event.results[0][0].transcript.toLowerCase();
                    evaluateSpeech(speechResult);
                };
                recognition.onend = () => {
                    isRecognitionActive = false;
                    document.getElementById('mic-button').classList.remove('mic-active');
                };
                recognition.onerror = () => {
                    isRecognitionActive = false;
                    document.getElementById('speaking-result').innerHTML = `<span class="text-red-500">Error: Couldn't hear you. Try again!</span>`;
                };
            }
        };

        function initVoices() {
            const synth = window.speechSynthesis;
            const findVoice = () => {
                const voices = synth.getVoices();
                currentVoice = voices.find(v => v.name === 'Google US English') ||
                               voices.find(v => v.lang === 'en-US') ||
                               voices.find(v => v.lang === 'en-GB') ||
                               voices.find(v => v.lang.startsWith('en'));
            };
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = findVoice;
            findVoice();
        }

        function updateSpeedUI() {
            voiceSpeed = parseFloat(document.getElementById('speed-control').value);
            document.getElementById('speed-val').innerText = `${voiceSpeed.toFixed(1)}x`;
        }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('header button').forEach(b => b.classList.remove('bg-white', 'shadow-sm', 'text-blue-600'));
            const activeBtn = document.getElementById(`tab-${tab}`);
            if (activeBtn) activeBtn.classList.add('bg-white', 'shadow-sm', 'text-blue-600');

            const sections = ['word-grid', 'game-interface', 'spelling-interface', 'speaking-interface', 'streak-box', 'search-box', 'custom-words-interface'];
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));

            if (tab === 'game') {
                document.getElementById('game-interface').classList.remove('hidden');
                document.getElementById('streak-box').classList.remove('hidden');
                document.getElementById('current-category-label').innerText = "Ear Trainer";
                startNewEarRound();
            } else if (tab === 'spelling') {
                document.getElementById('spelling-interface').classList.remove('hidden');
                document.getElementById('streak-box').classList.remove('hidden');
                document.getElementById('current-category-label').innerText = "Spelling Bee";
                setGameCategory(gameCategory);
            } else if (tab === 'speaking') {
                document.getElementById('speaking-interface').classList.remove('hidden');
                document.getElementById('streak-box').classList.remove('hidden');
                document.getElementById('current-category-label').innerText = "Speaking Challenge";
                setGameCategory(gameCategory);
            } else if (tab === 'custom') {
                document.getElementById('custom-words-interface').classList.remove('hidden');
                document.getElementById('word-grid').classList.remove('hidden');
                document.getElementById('search-box').classList.remove('hidden');
                document.getElementById('current-category-label').innerText = "My Custom Words";
                renderWords();
            } else {
                document.getElementById('word-grid').classList.remove('hidden');
                document.getElementById('search-box').classList.remove('hidden');
                const labels = { cvc: 'CVC Words', cvcc: 'CVCC Words', other: 'Advanced Words' };
                document.getElementById('current-category-label').innerText = labels[tab];
                renderWords();
            }
            updateProgressUI();
        }

        function renderWords(filter = '') {
            const grid = document.getElementById('word-grid');
            grid.innerHTML = '';
            const words = (wordData[currentTab] || []).filter(w => w.en.toLowerCase().includes(filter.toLowerCase()));
            words.forEach(w => {
                const card = document.createElement('div');
                const done = progress[currentTab]?.has(w.en);
                card.className = `word-card bg-white p-5 rounded-2xl border-2 text-center ${done ? 'border-green-100 bg-green-50/30' : 'border-slate-100'}`;
                card.onclick = () => speak(w.en);
                card.innerHTML = `<span class="block font-bold text-slate-700">${w.en}</span><span class="text-[10px] text-slate-400 uppercase italic">${w.fr || ''}</span>`;
                grid.appendChild(card);
            });
            document.getElementById('no-results').classList.toggle('hidden', words.length > 0);
        }

        function addCustomWords() {
            const raw = document.getElementById('custom-upload-input').value;
            raw.split('\n').map(l => l.trim()).filter(l => l).forEach(en => {
                if (!wordData.custom.find(x => x.en === en)) wordData.custom.push({ en, fr: null });
            });
            document.getElementById('custom-upload-input').value = '';
            saveProgress();
            renderWords();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                content.split(/\r?\n/).map(l => l.trim()).filter(l => l).forEach(en => {
                    if (!wordData.custom.find(x => x.en === en)) wordData.custom.push({ en, fr: null });
                });
                saveProgress();
                renderWords();
            };
            reader.readAsText(file);
        }

        function clearCustomWords() {
            if (confirm("Delete all custom words?")) { wordData.custom = []; saveProgress(); renderWords(); }
        }

        function setGameCategory(cat) {
            if (cat === 'custom' && wordData.custom.length === 0) return alert("Add custom words first!");
            gameCategory = cat;
            document.querySelectorAll(`.cat-pill[id*='cat-']`).forEach(p => {
                const isMatch = p.id.includes(`-${cat}`);
                p.classList.toggle('active-pill', isMatch);
                p.classList.toggle('bg-blue-600', isMatch);
                p.classList.toggle('text-white', isMatch);
            });
            if (currentTab === 'spelling') startNewSpellingRound();
            if (currentTab === 'speaking') startNewSpeakingRound();
        }

        function startNewEarRound() {
            const all = [...wordData.cvc, ...wordData.cvcc, ...wordData.other, ...wordData.custom];
            currentGameWord = all[Math.floor(Math.random() * all.length)];
            const options = [currentGameWord, ...all.filter(x => x.en !== currentGameWord.en).sort(() => Math.random() - 0.5).slice(0,3)].sort(() => Math.random() - 0.5);
            const container = document.getElementById('game-options');
            container.innerHTML = '';
            options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "game-card bg-slate-50 border-2 border-slate-100 p-6 rounded-2xl font-bold";
                b.onclick = () => {
                    if (opt.en === currentGameWord.en) { sounds.win(); streak++; startNewEarRound(); }
                    else { sounds.fail(); streak = 0; b.classList.add('shake'); }
                    updateProgressUI();
                };
                b.innerText = opt.en;
                container.appendChild(b);
            });
            setTimeout(() => speak(currentGameWord.en, false), 500);
        }

        function startNewSpellingRound() {
            const list = wordData[gameCategory];
            currentGameWord = list[Math.floor(Math.random() * list.length)];
            document.getElementById('spelling-input').value = '';
            document.getElementById('spelling-hint').innerText = '';
            document.getElementById('spelling-input').focus();
            setTimeout(() => speak(currentGameWord.en, false), 500);
        }

        function checkSpelling() {
            const val = document.getElementById('spelling-input').value.trim().toLowerCase();
            if (val === currentGameWord.en.toLowerCase()) { sounds.win(); streak++; startNewSpellingRound(); }
            else { sounds.fail(); streak = 0; document.getElementById('spelling-hint').innerText = "Incorrect. Try again!"; }
            updateProgressUI();
        }

        // --- Speaking Mode Updated Logic ---
        function startNewSpeakingRound() {
            const list = wordData[gameCategory];
            currentGameWord = list[Math.floor(Math.random() * list.length)];
            document.getElementById('speaking-target-word').innerText = currentGameWord.en;
            document.getElementById('speaking-target-fr').innerText = currentGameWord.fr || '';
            document.getElementById('speaking-result').innerHTML = '';
            document.getElementById('heard-display').classList.add('hidden');
            document.getElementById('check-next-btn').classList.add('hidden');
            document.getElementById('mic-button').classList.remove('hidden');
        }

        function startVoiceRecognition() {
            if (!recognition) return alert("Speech recognition not supported in this browser.");
            if (isRecognitionActive) return;
            
            audioCtx.resume();
            document.getElementById('mic-button').classList.add('mic-active');
            document.getElementById('speaking-result').innerHTML = `<span class="text-blue-500">Listening...</span>`;
            document.getElementById('heard-display').classList.add('hidden');
            
            try {
                recognition.start();
            } catch (e) {
                isRecognitionActive = false;
                document.getElementById('mic-button').classList.remove('mic-active');
            }
        }

        function evaluateSpeech(result) {
            const target = currentGameWord.en.toLowerCase();
            const heardDisplay = document.getElementById('heard-display');
            const transcriptText = document.getElementById('transcript-text');
            const resultMsg = document.getElementById('speaking-result');
            const checkBtn = document.getElementById('check-next-btn');

            heardDisplay.classList.remove('hidden');
            transcriptText.innerText = result;

            if (result.includes(target)) {
                sounds.win();
                resultMsg.innerHTML = `<span class="text-green-600">Perfect! You pronounced it correctly.</span>`;
                checkBtn.classList.remove('hidden');
                document.getElementById('mic-button').classList.add('hidden');
            } else {
                sounds.fail();
                resultMsg.innerHTML = `<span class="text-orange-500">Not quite. Try saying it again.</span>`;
            }
        }

        function validateAndProceed() {
            streak++;
            updateProgressUI();
            startNewSpeakingRound();
        }

        function speak(word, markDone = true) {
            const u = new SpeechSynthesisUtterance(word);
            u.lang = 'en-US';
            u.voice = currentVoice;
            u.rate = voiceSpeed;
            if (markDone) {
                const toast = document.getElementById('audio-toast');
                document.getElementById('toast-word').innerText = word.toUpperCase();
                toast.classList.replace('opacity-0', 'opacity-100');
                toast.classList.replace('translate-y-10', 'translate-y-0');
                setTimeout(() => { toast.classList.replace('opacity-100', 'opacity-0'); toast.classList.replace('translate-y-0', 'translate-y-10'); }, 1200);
                if (progress[currentTab]) { progress[currentTab].add(word); saveProgress(); renderWords(); updateProgressUI(); }
            }
            window.speechSynthesis.speak(u);
        }

        function updateProgressUI() {
            document.getElementById('current-streak-val').innerText = streak;
            if (['game', 'spelling', 'speaking'].includes(currentTab)) {
                document.getElementById('progress-text').innerText = streak * 10;
                document.getElementById('stat-label-1').innerText = "Score";
            } else {
                const count = wordData[currentTab]?.length || 0;
                const done = progress[currentTab]?.size || 0;
                document.getElementById('progress-text').innerText = `${done}/${count}`;
                document.getElementById('stat-label-1').innerText = "Progress";
            }
        }

        function saveProgress() {
            localStorage.setItem('esl_lab_final', JSON.stringify({
                p: { cvc: [...progress.cvc], cvcc: [...progress.cvcc], other: [...progress.other], custom: [...progress.custom] },
                cw: wordData.custom
            }));
        }

        function loadProgress() {
            const saved = localStorage.getItem('esl_lab_final');
            if (saved) {
                const d = JSON.parse(saved);
                progress.cvc = new Set(d.p?.cvc || []); 
                progress.cvcc = new Set(d.p?.cvcc || []);
                progress.other = new Set(d.p?.other || []); 
                progress.custom = new Set(d.p?.custom || []);
                wordData.custom = d.cw || [];
            }
        }
        
        function handleSearch() { renderWords(document.getElementById('search-input').value); }
        function playCurrentGameWord() { if (currentGameWord) speak(currentGameWord.en, false); }
    </script>
</body>
</html>
